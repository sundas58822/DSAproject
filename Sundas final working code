#include <iostream>
#include <string>
#include <vector>
#include <queue>
#include <stack>
#include <algorithm>
#include <ctime>
#include <cstdlib>
#include <limits>
#include <conio.h>
#include <sstream>
#include <windows.h>

using namespace std;

// ===============================
// COLOR HANDLING FOR WINDOWS
// ===============================
void setColor(int color) {
    SetConsoleTextAttribute(GetStdHandle(STD_OUTPUT_HANDLE), color);
}

// ===============================
// HELPER FUNCTIONS
// ===============================
void clearScreen() { system("cls"); }

void waitForEnter() {
    cout << "Press ENTER to continue...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
}

string intToString(int x) {
    stringstream ss;
    ss << x;
    return ss.str();
}

// ===============================
// CARD CLASS
// ===============================
class Card {
private:
    string name;
    int power;
    string rarity;

public:
    Card() { name = "Unknown"; power = 0; rarity = "Common"; }
    Card(string n, int p, string r) { name = n; power = p; rarity = r; }

    string getName() const { return name; }
    int getPower() const { return power; }
    string getRarity() const { return rarity; }

    int rarityColor() const {
        if (rarity == "Legendary") return 12; // Red
        if (rarity == "Epic") return 13;      // Magenta
        if (rarity == "Rare") return 9;       // Blue
        return 7;                             // White
    }

    void display() const {
        setColor(rarityColor());
        cout << name << " (" << rarity << " | Power: " << power << ")";
        setColor(7);
    }
};

// ===============================
// PLAYER CLASS
// ===============================
class Player {
private:
    string name;
    queue<Card> deck;
    stack<Card> discard;

public:
    Player(string n = "Player") { name = n; }

    void setName(string n) { name = n; }
    string getName() const { return name; }

    void addCardToDeck(const Card &c) { deck.push(c); }
    bool hasCards() const { return !deck.empty(); }
    int remainingCards() const { return (int)deck.size(); }

    Card drawCard() {
        Card c = deck.front();
        deck.pop();
        return c;
    }

    void addWinCards(const Card &c1, const Card &c2) {
        discard.push(c1);
        discard.push(c2);
    }

    void keepOwnCard(const Card &c) { discard.push(c); }
    int getScore() const { return (int)discard.size(); }
    queue<Card> getDeckSnapshot() const { return deck; }
};

// ===============================
// GAME CLASS
// ===============================
class Game {
private:
    vector<Card> cardPool;
    Player p1, p2;
    bool vsComputer;
    int roundNumber;

public:
    Game() { vsComputer = true; roundNumber = 1; }

    // ===============================
    // DISPLAY FUNCTIONS
    // ===============================
    void showTitleScreen() {
        clearScreen();
        setColor(11); // Cyan
        cout << "=====================================\n";
        cout << "           CARD BATTLE GAME          \n";
        cout << "=====================================\n";
        cout << "       A DSA-based Console Game      \n";
        cout << "-------------------------------------\n\n";
        setColor(7);
    }

    int showStartMenu() {
        int choice = -1;
        do {
            setColor(14); cout << "1. Start New Game\n0. Exit\nEnter choice: "; setColor(7);
            cin >> choice;
            if (cin.fail()) { cin.clear(); cin.ignore(numeric_limits<streamsize>::max(), '\n'); choice = -1; }
        } while (choice != 0 && choice != 1);
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
        return choice;
    }

    void chooseMode() {
        int mode = -1;
        do {
            clearScreen();
            setColor(11); cout << "Choose Game Mode:\n"; setColor(7);
            setColor(14); cout << "1. Player vs Computer\n2. Player vs Player\nEnter choice: "; setColor(7);
            cin >> mode;
            if (cin.fail()) { cin.clear(); cin.ignore(numeric_limits<streamsize>::max(), '\n'); mode = -1; }
        } while (mode != 1 && mode != 2);
        vsComputer = (mode == 1);
        cin.ignore(numeric_limits<streamsize>::max(), '\n');
    }

    void setupPlayers() {
        clearScreen();
        string name;
        setColor(11); cout << "Enter Player 1 name: "; setColor(7);
        getline(cin, name); if (name.empty()) name = "Player1"; p1.setName(name);

        if (vsComputer) { p2.setName("Computer"); }
        else {
            setColor(11); cout << "Enter Player 2 name: "; setColor(7);
            getline(cin, name); if (name.empty()) name = "Player2"; p2.setName(name);
        }

        clearScreen();
        setColor(10); cout << "Match Setup:\n"; setColor(7);
        cout << p1.getName() << "  VS  " << p2.getName() << "\n";
        waitForEnter();
    }

    void askGameSettings(int &totalCards, int &distMode) {
        clearScreen();
        do {
            setColor(14); cout << "Enter TOTAL number of cards (even number, min 4): "; setColor(7);
            cin >> totalCards;
            if (cin.fail()) { cin.clear(); cin.ignore(numeric_limits<streamsize>::max(), '\n'); totalCards = -1; }
        } while (totalCards < 4);
        if (totalCards % 2 != 0) { totalCards--; setColor(13); cout << "Adjusted to even total: " << totalCards << "\n"; setColor(7); }

        do {
            setColor(11); cout << "\nChoose card distribution style:\n"; setColor(7);
            setColor(14); cout << "1. Alternate dealing\n2. First half to P1\n3. Random equal\nEnter choice: "; setColor(7);
            cin >> distMode;
            if (cin.fail()) { cin.clear(); cin.ignore(numeric_limits<streamsize>::max(), '\n'); distMode = -1; }
        } while (distMode < 1 || distMode > 3);
        cin.ignore(numeric_limits<streamsize>::max(), '\n');

        clearScreen();
        setColor(11); cout << "Game Settings:\n"; setColor(7);
        setColor(14); cout << "Total cards: " << totalCards << "\nDistribution mode: " << distMode << "\n"; setColor(7);
        waitForEnter();
    }

    string getRarity(int power) {
        if (power >= 90) return "Legendary";
        if (power >= 70) return "Epic";
        if (power >= 50) return "Rare";
        return "Common";
    }

    void generateAndDistributeCards(int totalCards, int distMode) {
        clearScreen(); setColor(11); cout << "Generating cards...\n"; setColor(7);

        vector<string> baseNames;
        baseNames.push_back("Knight"); baseNames.push_back("Dragon"); baseNames.push_back("Wizard");
        baseNames.push_back("Archer"); baseNames.push_back("Assassin"); baseNames.push_back("Golem");
        baseNames.push_back("Hunter"); baseNames.push_back("Paladin"); baseNames.push_back("Samurai"); baseNames.push_back("Mage");

        cardPool.clear();
        for (int i = 0; i < totalCards; ++i) {
            string nm = baseNames[i % baseNames.size()] + " #" + intToString(i + 1);
            int power = (rand() % 91) + 10;
            string rarity = getRarity(power);
            cardPool.push_back(Card(nm, power, rarity));
        }

        random_shuffle(cardPool.begin(), cardPool.end());

        p1 = Player(p1.getName());
        p2 = Player(p2.getName());

        int half = totalCards / 2;

        if (distMode == 1) for (int i = 0; i < totalCards; i++) (i % 2 == 0 ? p1 : p2).addCardToDeck(cardPool[i]);
        else if (distMode == 2) for (int i = 0; i < totalCards; i++) (i < half ? p1 : p2).addCardToDeck(cardPool[i]);
        else {
            int p1count = 0;
            for (int i = 0; i < totalCards; i++) {
                if ((rand() % 2 == 0 && p1count < half) || (i - p1count) >= half) { p1.addCardToDeck(cardPool[i]); p1count++; }
                else p2.addCardToDeck(cardPool[i]);
            }
        }

        clearScreen(); setColor(10); cout << "Decks are ready!\n\n"; setColor(7);
        cout << p1.getName() << " has " << p1.remainingCards() << " cards.\n";
        cout << p2.getName() << " has " << p2.remainingCards() << " cards.\n";
        waitForEnter();

        roundNumber = 1;
    }

    // ===============================
    // DECK & ROUND FUNCTIONS
    // ===============================
    void printDeckList(const Player &pl) {
        setColor(11); cout << pl.getName() << "'s current deck:\n"; setColor(7);
        queue<Card> temp = pl.getDeckSnapshot();
        if (temp.empty()) { cout << "  [No cards]\n"; return; }
        int idx = 1;
        while (!temp.empty()) { cout << idx++ << ". "; temp.front().display(); cout << "\n"; temp.pop(); }
        cout << "\n";
    }

    int compareCards(const Card &c1, const Card &c2) {
        if (c1.getPower() > c2.getPower()) return 1;
        if (c2.getPower() > c1.getPower()) return -1;
        return 0;
    }

    void playRound() {
        if (!p1.hasCards() || !p2.hasCards()) { setColor(12); cout << "Cannot play round: one deck empty.\n"; setColor(7); waitForEnter(); return; }
        clearScreen(); setColor(11); cout << "========== ROUND " << roundNumber << " ==========\n\n"; setColor(7);

        printDeckList(p1); printDeckList(p2);

        cout << "Press ENTER to draw cards..."; cin.ignore(numeric_limits<streamsize>::max(), '\n');

        Card c1 = p1.drawCard();
        Card c2 = p2.drawCard();

        setColor(10); cout << p1.getName() << " plays: "; setColor(7); c1.display(); cout << "\n";
        setColor(10); cout << p2.getName() << " plays: "; setColor(7); c2.display(); cout << "\n\n";

        int res = compareCards(c1, c2);
        if (res == 1) { setColor(10); cout << p1.getName() << " wins this round!\n"; setColor(7); p1.addWinCards(c1, c2); }
        else if (res == -1) { setColor(10); cout << p2.getName() << " wins this round!\n"; setColor(7); p2.addWinCards(c1, c2); }
        else { setColor(13); cout << "It's a draw. Each keeps their card.\n"; setColor(7); p1.keepOwnCard(c1); p2.keepOwnCard(c2); }

        setColor(11); cout << "\nRemaining cards:\n"; setColor(7);
        cout << p1.getName() << ": " << p1.remainingCards() << "\n";
        cout << p2.getName() << ": " << p2.remainingCards() << "\n";

        roundNumber++;
        waitForEnter();
    }

    void showScores() {
        clearScreen(); setColor(11); cout << "======== CURRENT SCORE ========\n"; setColor(7);
        cout << p1.getName() << ": " << p1.getScore() << "\n";
        cout << p2.getName() << ": " << p2.getScore() << "\n";
        waitForEnter();
    }

    void viewDeckMenu() { clearScreen(); printDeckList(p1); waitForEnter(); }

    void showFinalResult() {
        clearScreen();
        int s1 = p1.getScore(), s2 = p2.getScore();
        setColor(11); cout << "========== FINAL RESULT ==========\n"; setColor(7);
        cout << p1.getName() << ": " << s1 << "\n";
        cout << p2.getName() << ": " << s2 << "\n";
        if (s1 > s2) { setColor(10); cout << "\nWINNER: " << p1.getName() << "\n"; setColor(7); }
        else if (s2 > s1) { setColor(10); cout << "\nWINNER: " << p2.getName() << "\n"; setColor(7); }
        else { setColor(13); cout << "\nMATCH DRAW\n"; setColor(7); }
        waitForEnter();
    }

    // ===============================
    // GAME LOOP
    // ===============================
    void gameLoop() {
        while (p1.hasCards() && p2.hasCards()) {
            clearScreen();
            setColor(14);
            cout << "======== GAME MENU ========\n";
            cout << "1. Play Next Round\n2. View Scores\n3. View Deck\n0. End Game Now\n";
            cout << "===========================\nEnter choice: "; setColor(7);
            int ch; cin >> ch; cin.ignore(numeric_limits<streamsize>::max(), '\n');
            if (ch == 1) playRound();
            else if (ch == 2) showScores();
            else if (ch == 3) viewDeckMenu();
            else if (ch == 0) { showFinalResult(); break; }
        }
        if (!p1.hasCards() || !p2.hasCards()) showFinalResult();
    }

    void runSingleGame() {
        chooseMode();
        setupPlayers();
        int totalCards, distMode;
        askGameSettings(totalCards, distMode);
        generateAndDistributeCards(totalCards, distMode);
        gameLoop();
    }

    void run() {
        while (true) {
            showTitleScreen();
            int choice = showStartMenu();
            if (choice == 0) { clearScreen(); setColor(10); cout << "Thanks for playing Card Battle Game!\n"; setColor(7); break; }
            runSingleGame();
        }
    }
};

// ===============================
// MAIN
// ===============================
int main() {
    srand((unsigned)time(0));
    Game game;
    game.run();
    setColor(14); cout << "\nPress any key to exit..."; setColor(7);
    getch();
    return 0;
}
